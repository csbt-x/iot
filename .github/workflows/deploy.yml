# Automatic or manual deployment of the stack using specified docker manager image tag from docker hub
# or alternatively a git commit can be sepcified to build a custom manager image.
#
# If this is a custom project (i.e. has openremote submodule) or deployment/Dockerfile exists then a
# deployment image will also be built and loaded on the host.
#
# If triggered by a webhook then the payload must contain an inputs object with the same keys as the
# workflow_dispatch inputs
#
# Inputs:
#
# - environment  - used to load the specified environment from github; this can then contain specific
#                  secrets to override default values; these are overlayed ontop of the repo and org
#                  secrets
# - host         - DNS URL for the host (default: secrets.HOST)
# - ssh_user     - SSH username (default: secrets.SSH_USER || root)
# - ssh_password - SSH password (default: secrets.SSH_PASSWORD)
# - ssh_key      - SSH private key (default: secrets.SSH_KEY)
# - ssh_port     - SSH port (default: secrets.SSH_PORT || 22)
# - password     - Admin password to be set on deployment; sets the SETUP_ADMIN_PASSWORD env variable
#                 (default: secrets.SETUP_ADMIN_PASSWORD || secret)
# - managerTag   - The docker tag to pull for the manager image; if not specified then the manager image
#                  will be built using the specified commit or latest branch commit
# - commit       - Which commit or branch to use on this repo (default: branch on which workflow is executed)
# - platform     - The host platform architecture (default: secrets.PLATFORM || linux/amd64)
#
# Secrets:
#
# The following secrets are supported (* are required)
#
# - DOCKERHUB_USER
# - DOCKERHUB_PASSWORD
# - HOST
# - SSH_USER
# - SSH_PORT
# - SSH_PASSWORD
# - SSH_KEY
# - SETUP_ADMIN_PASSWORD


name: Deploy

on:
  # Manually request a deploy
  workflow_dispatch:
    inputs:
      host:
        description: 'Host to deploy to'
      ssh_user:
        description: 'SSH Username'
      ssh_port:
        description: 'SSH port'
      ssh_password:
        description: 'SSH password'
      ssh_key:
        description: 'SSH key'
      password:
        description: 'Admin password override'
      managerTag:
        description: 'Manager docker tag to pull'
      commit:
        description: 'Repo branch or commit SHA to use'
      environment:
        description: 'Environment to use (if any)'
      platform:
        description: 'Host platform architecture'
        default: linux/amd64
      
        
  # Docker push webhook trigger
  repository_dispatch:
    types: [docker-push]

env:
  environment: staging

jobs:

  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
    
      - name: Login to DockerHub
        if: ${{ env.USER != '' && env.PASSWORD != '' }}
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
        env:
          USER: ${{ secrets.DOCKERHUB_USER }}
          PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
          
      - name: Output secrets to ENV ready for overwrites from inputs
        run: |
          while read -r key value; do
            if [[ $key == *$'\n'* ]]; then
              echo $key'<<@@@' >> env.txt
              echo $value >> env.txt
              echo '@@@' >> env.txt
            elif [[ ! -z $key ]]; then
              echo "$key=$value" >> env.txt
            fi
          done< <(jq -r 'to_entries|.[] | "\(.key) \(.value)"' <<< $secrets)
        env:
          secrets: ${{ toJson(secrets) }}
            
      - run: echo "${{ toJson(secrets) }}" >> secrets.txt
            
      - name: Setup upterm session
        uses: lhotari/action-upterm@v1
        with:
          ## limits ssh access and adds the ssh public keys of the listed GitHub users
          limit-access-to-users: richturner
      
#       - name: Determine host name
#         id: host-name
#         run: echo "HOST=${{ github.event.inputs.host || env.HOST }}" >> $GITHUB_ENV
        
#       - name: Host not set
#         if: ${{ env.HOST == '' }}
#         run: exit 1
                
#       - name: Determine SSH username
#         run: echo "SSH_USER=${{ github.event.inputs.ssh_user || env.SSH_USER || 'root' }}" >> $GITHUB_ENV
                
#       - name: Determine SSH port
#         run: echo "SSH_PORT=${{ github.event.inputs.ssh_port || env.SSH_PORT || '22' }}" >> $GITHUB_ENV
                        
#       - name: Determine SSH password
#         run: echo "SSH_PASSWORD=${{ github.event.inputs.ssh_password || env.SSH_PASSWORD }}" >> $GITHUB_ENV
                        
#       - name: Determine SSH key
#         run: echo "SSH_KEY=${{ github.event.inputs.ssh_key || env.SSH_KEY }}" >> $GITHUB_ENV
        
        

      - name: executing remote ssh commands using password
        uses: appleboy/ssh-action@master
        with:
          host: staging.demo.openremote.io
          username: ubuntu
          key: ${{ env.SSHKEY }}
          port: 22
          script: whoami

      - run: exit 1
        
      - name: Determine platform
        run: echo "PLATFORM=${{ github.event.inputs.platform || env.PLATFORM || 'linux/amd64' }}" >> $GITHUB_ENV
        
      - name: Check manager tag input
        if: github.event.inputs.managerTag != ''
        run: |
          docker manifest inspect openremote/manager:${{ github.event.inputs.managerTag }} > /dev/null 2> /dev/null

      - name: Determine password
        id: password
        run: echo "SETUP_ADMIN_PASSWORD=${{ github.event.inputs.password || env.SETUP_ADMIN_PASSWORD || 'secret' }}" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{github.event.inputs.commit}}
          submodules: recursive
          
      - name: Check deployment existence
        id: check_deployment_dir
        uses: andstor/file-existence-action@v1
        with:
          files: "deployment/Dockerfile"          
          
      - name: Check custom project
        id: check_custom_project
        uses: andstor/file-existence-action@v1
        with:
          files: "openremote"
        
      - name: Determine compose file path
        id: compose-file
        run: |
          if [ ! -z $ENV_COMPOSE_FILE ]; then
            echo "COMPOSE_FILE=$ENV_COMPOSE_FILE" >> $GITHUB_ENV
          elif [ -f "profile/$ENVIRONMENT.yml" ]; then
            echo "COMPOSE_FILE=profile/$ENVIRONMENT.yml" >> $GITHUB_ENV
          else
            echo "COMPOSE_FILE=docker-compose.yml" >> $GITHUB_ENV
          fi
        env:
          ENV_COMPOSE_FILE: ${{ secrets.COMPOSE_FILE }}
          ENVIRONMENT: ${{ github.event.inputs.environment }}
        
      - name: Determine manager image info
        id: manager-image
        run: |          
          if [ ! -z $INPUT_TAG ]; then
            echo "MANAGER_TAG=$INPUT_TAG" >> $GITHUB_ENV
          elif [ $CUSTOM_PROJECT == 'true' ]; then
            echo "MANAGER_BUILD=true" >> $GITHUB_ENV
            echo "MANAGER_PATH=openremote/manager/build/install/manager" >> $GITHUB_ENV
            echo "MANAGER_TAG=$(cd openremote; git rev-parse --short HEAD; cd ..)" >> $GITHUB_ENV
          else
            echo "MANAGER_BUILD=true" >> $GITHUB_ENV
            echo "MANAGER_PATH=manager/build/install/manager" >> $GITHUB_ENV
            echo "MANAGER_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          fi
        env:
          INPUT_TAG: ${{ github.event.inputs.managerTag }}
          CUSTOM_PROJECT: ${{ steps.check_custom_project.outputs.file_exists }}

      - name: Determine deployment image info
        id: deployment-image
        if: steps.check_deployment_dir.outputs.files_exists == 'true'
        run: |
          echo "DEPLOYMENT_BUILD=true" >> $GITHUB_ENV
          echo "DEPLOYMENT_PATH=deployment/build" >> $GITHUB_ENV
          echo "DEPLOYMENT_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Output info
        run: |
          echo "************************************************************"
          echo "**************           INFO            *******************"
          echo "************************************************************"
          echo "Host: ${{ env.HOST }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Platform: ${{ env.PLATFORM }}"
          echo "Compose file: ${{ env.COMPOSE_FILE }}"
          echo "Manager build: ${{ env.MANAGER_BUILD == 'true' }}"
          echo "Manager tag: ${{ env.MANAGER_TAG }}"
          echo "Manager build path: ${{ env.MANAGER_PATH }}"
          echo "Deployment build: ${{ env.DEPLOYMENT_BUILD == 'true' }}"
          echo "Deployment tag: ${{ env.DEPLOYMENT_TAG }}"
          echo "Deployment build path: ${{ env.DEPLOYMENT_PATH }}"
          echo "************************************************************"
          echo "************************************************************"
  
      - name: Copy compose file (test SSH connection before building)
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          key: ${{ env.SSH_KEY }}
          source: ${{ env.COMPOSE_FILE }}
          target: "~"
  
      - name: Do code build
        run: |
          if [ $MANAGER_BUILD == 'true' ]; then
            echo "./gradlew installDist"
          elif [ $DEPLOYMENT_BUILD == 'true' ]; then
            echo "./gradlew -p deployment installDist"
          fi
          
      - name: set up QEMU
        uses: docker/setup-qemu-action@v1
        with:
          platforms: ${{ env.PLATFORM }}

      - name: install buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          version: latest
          install: true

      - name: Build manager image
        if: ${{ env.MANAGER_BUILD == 'true' }}
        run: echo "docker build --platform $PLATFORM -t openremote/manager:$MANAGER_TAG $MANAGER_PATH"

      - name: Build deployment image
        if: ${{ env.DEPLOYMENT_BUILD == 'true' }}
        run: echo "docker build --platform $PLATFORM -t openremote/deployment:$DEPLOYMENT_TAG $DEPLOYMENT_PATH"

